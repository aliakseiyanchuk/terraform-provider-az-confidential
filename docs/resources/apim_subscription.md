---
# generated by https://github.com/hashicorp/terraform-plugin-docs
page_title: "az-confidential_apim_subscription Resource - az-confidential"
subcategory: ""
description: |-
  Creates a subscription with specified primary and secondary subscription
  keys without revealing these  value in state.
  This resource can be used e.g. in a situation where an Terraform practitioner
  needs to manage a high number of periodically rotated subscription keys for
  multiple API consumers where (a) storing these keys in the Terraform code in the
  clear is not desired while (b) storing these keys in a Key Vault service
  creates a maintenance overhead.
  How to create the ciphertext
  The ciphertext (i.e. the value of the content attribute) can be created with the encrypt_apim_subscription function.
  This function will generate only the ciphertext. A complimentary tfgen https://github.com/aliakseiyanchuk/terraform-provider-az-confidential-tfgen
  tool can used to generate both ciphertext
  and the Terraform code template.
  As a pre-requisite, you need to have a public key of the key-encryption key the action provider instance will
  be using.
  Example how to create ciphertext using Terraform provider
  Consider the following example that creates a ciphertext that can be used for test and acceptance purposes for
  next year when the content should not be read more than 50 times:
  
  variable "primary_key" {
    type        = string
    description = "Primary subscription key value"
  }
  variable "secondary_key" {
    type        = string
    description = "Secondary subscription key value"
  }
  
  variable "public_key_file" {
    type        = string
    description = "Public key file"
  }
  
  locals {
    public_key = file(var.public_key_file)
  }
  
  output "encrypted_apim_subscription" {
    value = provider::az-confidential::encrypt_apim_subscription (
      {
        primary_key   = var.primary_key
        secondary_key = var.secondary_key
      },
      {
        # These parameters are typically known upfront and can be considered
        # long-lived or fixed. If desired, these values can also be expressed
        # as variables.
        az_subscription_id  = "123421"
        resource_group      = "rg"
        api_management_name = "apim"
        apim_subscription_id : "subscriptionId",
        api_id     = "",
        product_id = "productId"
        user_id    = "abc-def"
      },
      {
        create_limit  = "72h"
        expires_after = 365
        num_uses      = 50
        provider_constraints = toset(["test", "acceptance"])
      },
      local.public_key
    )
  }
  
  
  Please refer to the encrypt_apim_subscription function documentation ../functions/encrypt_apim_subscription.md
  for the description of the parameters the function accepts.
  Create ciphertext using tfgen tool
  The ciphertext as well as a complete Terraform datasource template can be obtained using the tfgen command-line tool
  (see source code https://github.com/aliakseiyanchuk/terraform-provider-az-confidential-tfgen.)
  The prompt equivalent to the function invocation illustrated above is:
  
  tfgen -pubkey [path to the public key] \
    -provider-constraints demo,acceptance \
    -num-uses 50 \
    apim subscription
  
  The tool will prompt for the interactive content input. Further options can be obtained by tfgen -help and
  tfgen apim subscription -help commands.
---

# az-confidential_apim_subscription (Resource)

Creates a subscription with specified primary and secondary subscription
keys without revealing these  value in state.

This resource can be used e.g. in a situation where an Terraform practitioner
needs to manage a high number of periodically rotated subscription keys for 
multiple API consumers where (a) storing these keys in the Terraform code in the 
clear is not desired while (b) storing these keys in a Key Vault service
creates a maintenance overhead.

## How to create the ciphertext
The ciphertext (i.e. the value of the `content` attribute) can be created with the `encrypt_apim_subscription` function.
This function will generate only the ciphertext. A complimentary [`tfgen`](https://github.com/aliakseiyanchuk/terraform-provider-az-confidential-tfgen)
tool can used to generate both ciphertext
and the Terraform code template.

As a pre-requisite, you need to have a public key of the key-encryption key the action provider instance will
be using.

### Example how to create ciphertext using Terraform provider

Consider the following example that creates a ciphertext that can be used for test and acceptance purposes for
next year when the content should not be read more than 50 times:

```terraform
variable "primary_key" {
  type        = string
  description = "Primary subscription key value"
}
variable "secondary_key" {
  type        = string
  description = "Secondary subscription key value"
}

variable "public_key_file" {
  type        = string
  description = "Public key file"
}

locals {
  public_key = file(var.public_key_file)
}

output "encrypted_apim_subscription" {
  value = provider::az-confidential::encrypt_apim_subscription (
    {
      primary_key   = var.primary_key
      secondary_key = var.secondary_key
    },
    {
      # These parameters are typically known upfront and can be considered
      # long-lived or fixed. If desired, these values can also be expressed
      # as variables.
      az_subscription_id  = "123421"
      resource_group      = "rg"
      api_management_name = "apim"
      apim_subscription_id : "subscriptionId",
      api_id     = "",
      product_id = "productId"
      user_id    = "abc-def"
    },
    {
      create_limit  = "72h"
      expires_after = 365
      num_uses      = 50
      provider_constraints = toset(["test", "acceptance"])
    },
    local.public_key
  )
}

```

Please refer to the [`encrypt_apim_subscription` function documentation](../functions/encrypt_apim_subscription.md)
for the description of the parameters the function accepts.

### Create ciphertext using `tfgen` tool

The ciphertext as well as a complete Terraform datasource template can be obtained using the `tfgen` command-line tool
(see [source code](https://github.com/aliakseiyanchuk/terraform-provider-az-confidential-tfgen).)
The prompt equivalent to the function invocation illustrated above is:
```shell
tfgen -pubkey [path to the public key] \
  -provider-constraints demo,acceptance \
  -num-uses 50 \
  apim subscription
```
The tool will prompt for the interactive content input. Further options can be obtained by `tfgen -help` and
`tfgen apim subscription -help` commands.

## Example Usage

```terraform
resource "az-confidential_apim_subscription" "subscription" {
  content = <<-CIPHERTEXT
            H4sIAAAAAAAA/3SUTY+6SBfF93yK3vP4gLwIdNKZgA00yIuIqLiZFEWhCFJIVSHy6Sf/nv9iepKpTSW/
            m3vvuWdxFr+eZbte9LaOo70d7b8Jtx4QoCio7zV9f1tqqqIbirgyOHvq6+H1jVRNkn6hEJeo3aEKDaiD
            6P0N9PWfd9CBC7qjjgqEFQQOdU9r3Anjktu2AH5X1rgjdAB1R8n7G5gXcNGCArXvgvCjhwiioalQA/qi
            qIpioUADLgpVkRZqqRuSBIuyWiJhQASzASJ3wKwnAsRdVZeoozVoF80o9AMe6xINRAhrOGCCK/p/s6/D
            f+hEw1hDJAAIUU9BB9G/ZPwB+vrj16CSQfrx+/dKgRE0fHDb3wt+XFWiO/4fRYTW3YXbv/q/3Xn7D3c4
            zvUT6Lj5aJs+DF6xAtl1BuBhE8P1DudLLsmby2rOW6T1VrN64cdOvky1+1xuiufgnCsOrbaYuTNbeoZd
            4i5vH657wMc5OrGTstaYIDraw92JvBpDLL/Obdj7ijm50gOdEx5o3C32KmAvO6nWc5sx/BWdNl+vhEck
            m+XJSjuNxNMtOyRVlk6aX+hsoi5O2wOxSkNe91zCHm1p6ZkMpg4rUzHOe3CxNU+SHteKTMzzmXU0PZBX
            ztdLtAvHwfrYbK2qOEmnPV5ypnzzLkcM4k8ZmGM8FJmYhWbX+uujesJM3lZAq8KsS2IcXM+ddmKi78f+
            UbjcYzPJfU4iU+PxvEifAQyO3kpBu3a/UtZL0RSHqTnPjhYh4Znt9fOGVvzlvh6XgzQpLXPrVV8pnI9K
            218H0c5yAv01htWBN0M1y2n2nLPrhs+omOPac8FSI89Gqs47Q7wXfBUcw85NoxWXXvttlhDLSUNPFm/e
            LLYsxSckO41pjUiXDTclcXbckOt11dQ3f9l4l1ZLnyGgiAYKh3TBCwJaGYk0ig5tguSzCJiwqSJrNW70
            RMXh2O7K25GUa+Vq8rY1CmN7jyxRonVXPDmRQorC50CsfNL6q506G7y/fM1rE3XGuTNNMWj4sjuPX7F6
            G/Uj8/t+sl9qc0tjpchj7ks9pjcX9OkcyEEIolzkGXwcYBV7k2/H29vnYdxtPyVvn3xw35FhR58/I+Sv
            AAAA//8eo3x1WwQAAA==
            CIPHERTEXT

  display_name  = "confidentialSubscription"
  state         = "active"
  allow_tracing = false

  # A display name of this named value. It doesn't play a role in the actual operation;
  # whereas it's great to give it a descriptive name. If it is not specified, it is
  # inferred from the name of the destination named value.
  # display_name = "confidential named value"

  destination_subscription = {
    # Specify a Azure resource group  id where the APIM instance is created
    resource_group = var.az_apim_group_name
    # Specify a Azure APIM service name
    api_management_name = var.az_apim_service_name
    # Specify the identifier for this subscription
    # subscription_id = "...specify the APIM subscription id..."
    # Specify the API product
    product_id = "productId"
    # Specify the API this subscription will be bound with
    # api_id = "...specify the API this subscription will be associated with..."
    # Specify the API this subscription will be bound with
    # user_id = "...specify the user Id "
  }
}
```

<!-- schema generated by tfplugindocs -->
## Schema

### Required

- `content` (String) Encrypted confidential content to create this resource
- `destination_subscription` (Attributes) Defines the APIM subscription to be created (see [below for nested schema](#nestedatt--destination_subscription))

### Optional

- `allow_tracing` (Boolean) Whether to allow the tracing of policy execution for this subscription
- `display_name` (String) Display name of this subscription. Defaults to subscription Id if unspecified
- `state` (String) Required state of the subscription. Defaults to `active` if unspecified
- `wrapping_key` (Attributes) Wrapping key to use for key and secret unwrapping purposes (see [below for nested schema](#nestedatt--wrapping_key))

### Read-Only

- `id` (String) Identifier of the decryption operation
- `subscription_id` (String) Id of the subscription that actually created. Useful in case where destination_subscription does not set a required Id

<a id="nestedatt--destination_subscription"></a>
### Nested Schema for `destination_subscription`

Required:

- `api_management_name` (String) Resource group where APIM service is created
- `resource_group` (String) Resource group where APIM service is created

Optional:

- `api_id` (String) API for which the subscription needs to be created
- `apim_subscription_id` (String) API management subscription Id to use
- `az_subscription_id` (String) Id of this subscription where API Management service id deployed. Required if provider is not configured with a default Azure subscription, or the subscription differs from default
- `product_id` (String) Product for which the subscription needs to be created
- `user_id` (String) Product for which the subscription needs to be created


<a id="nestedatt--wrapping_key"></a>
### Nested Schema for `wrapping_key`

Optional:

- `algorithm` (String) Algorithm to use for unwrapping secret/content encryption key; defaults to RSA OAEP 256; a sensible default that doesn't need to be changed
- `name` (String) Name of the wrapping key
- `vault_name` (String) Vault name containing the wrapping key
- `version` (String) Version of the wrapping key to use for unwrapping operations
